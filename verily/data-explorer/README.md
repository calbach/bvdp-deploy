# data-explorer

Config/docs for Verily's internal BVDP data explorer usage. The Data Explorer
API server runs inside of the BVDP GKE cluster, along with a [Cloud Endpoints](
https://cloud.google.com/endpoints/docs/get-started-container-engine) server
that controls access. This endpoints server is exposed outside of the cluster.

The `yaml` tool is required for many of the operations in this document:
```
go get github.com/mikefarah/yaml
```


# Environments

## Dev

http://data-explorer.endpoints.bvdp-verily-dev.cloud.goog/v1/ui

For internal Verily use with loose ACL restrictions. Data may be wiped at any
time. Cloud project is [bvdp-verily-dev](
https://console.cloud.google.com/home/dashboard?project=bvdp-verily-dev).

The Helm release name is "de-dev".

### Rebuild

TODO(calbach): Add details once this is automated.

```
gcloud container builds submit --tag gcr.io/bvdp-verily-dev/data-explorer-service "$(git rev-parse --show-toplevel)/data-explorer-service"
```

### Upgrade

This pushes flags, k8s config changes, and new images.

```
gcloud container clusters get-credentials bvdp-dev --zone us-east1-b --project bvdp-verily-dev
helm upgrade de-dev . --values dev.values.yaml --kube-context $(kubectl config current-context)
```

### Sync Endpoints OpenAPI Spec

```
# Commit and send pull request for changes generated by the following:
endpoints/sync-api-dev.sh

# Once the pull request is approved, push:
gcloud service-management deploy endpoints/dev.swagger.yaml --project bvdp-verily-dev

# Feed the new config ID back into the k8s deployment:
config_id=$(gcloud service-management configs list --service data-explorer.endpoints.bvdp-verily-dev.cloud.goog --format="csv[no-heading](CONFIG_ID)" --limit 1)
yaml write -i dev.values.yaml esp.serviceConfigId "${config_id}"
```

Then, [upgrade](#upgrade) the deployment.

# Setup and new environments

See [initial k8s setup](../k8s/README.md), including kubectl configuration.

## Endpoints setup

1. Setup a script for cloning and overriding values in the OpenAPI spec, see
[sync-api-dev.sh](./endpoints/sync-api-dev.sh).
2. `gcloud service-management deploy FOO.swagger.yaml --project FOO_PROJECT`

## Starting the initial deployment

Create a new values yaml file, see [dev.values.yaml](./dev.values.yaml)

```
helm init
helm install . --name RELEASE_NAME --values VALUES_FILE --kube-context $(kubectl config current-context)
```
