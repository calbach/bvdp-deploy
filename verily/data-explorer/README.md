# data-explorer

Config/docs for Verily's internal BVDP data explorer usage. The Data Explorer
API server runs inside of the BVDP GKE cluster, along with a [Cloud Endpoints](
https://cloud.google.com/endpoints/docs/get-started-container-engine) server
that controls access. This endpoints server is exposed outside of the cluster.

The `yaml` tool is required for many of the operations in this document:
```
go get github.com/mikefarah/yaml
```


# Environments

## Dev

https://explorer-api-dot-bvdp-verily-dev.appspot.com/v1/ui

For internal Verily use with loose ACL restrictions. Data may be wiped at any
time. Cloud project is [bvdp-verily-dev](
https://console.cloud.google.com/home/dashboard?project=bvdp-verily-dev).

The GAE service name is ["explorer-api"](https://console.cloud.google.com/appengine/versions?project=bvdp-verily-dev&serviceId=explorer-api).

### Rebuild

TODO(calbach): Add details once this is automated.

```
gcloud container builds submit --tag gcr.io/bvdp-verily-dev/data-explorer-service "$(git rev-parse --show-toplevel)/data-explorer-service"
```

### Upgrade

This pushes flags and new images.

```
gcloud app deploy dev.app.yaml --image-url gcr.io/bvdp-verily-dev/data-explorer-service --project bvdp-verily-dev
```

### Sync Endpoints OpenAPI Spec

```
# Commit and send pull request for changes generated by the following:
git submodule foreach git pull origin master
sync-api-dev.sh

# Once the pull request is approved, push:
gcloud service-management deploy dev.swagger.yaml --project bvdp-verily-dev

# Feed the new config ID back into the GAE deployment:
config_id=$(gcloud service-management configs list --service explorer-api-dot-bvdp-verily-dev.appspot.com --format="csv[no-heading](CONFIG_ID)" --limit 1)
yaml write -i dev.app.yaml endpoints_api_service.config_id "${config_id}"
```

Then, [upgrade](#upgrade) the deployment.

# Setup and new environments

See [elasticsearch setup](../elasticsearch/README.md), including kubectl configuration.

## Endpoints setup

1. Setup a script for cloning and overriding values in the OpenAPI spec, see
[sync-api-dev.sh](./sync-api-dev.sh).
1. `gcloud service-management deploy FOO.swagger.yaml --project FOO_PROJECT`

## Starting the initial deployment

1. Build the image, tag, and push to gcr.io
1. Create a new app yaml file, see [dev.app.yaml](./dev.app.yaml)
1. Grab the GCP-region-specific internal load balancer for the ElasticSearch
   API:

    ```
    es_ilb_ip=$(kubectl get svc --namespace default FOO_ES_RELEASE_NAME-elasticsearch -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
    yaml write -i FOO.app.yaml env_variables.INDEX_ADDR "http://${es_ilb_ip}:9200"
    ```

1. Deploy:

    ```
    gcloud app deploy FOO.app.yaml --image-url gcr.io/FOO_PROJECT/data-explorer-service --project FOO_PROJECT
    ```
